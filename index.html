<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒª (è¤‡æ•°æ„å‘³å¯¾å¿œç‰ˆ)</title>
    <style>
        :root { --main-color: #007bff; --light-gray: #f8f9fa; --gray: #6c757d; --red: #dc3545; --green: #28a745; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background-color: var(--light-gray); display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background-color: #fff; margin: 20px; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; text-align: center; }
        .controls, .quiz-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .controls input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; border: none; border-radius: 4px; color: #fff; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--main-color); }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: var(--gray); }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: var(--green); }
        .btn-success:hover { background-color: #218838; }
        #word-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .word-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; }
        .word-item.checked { background-color: #e9f5ff; }
        .word-item input[type="checkbox"] { margin-top: 5px; width: 18px; height: 18px; flex-shrink: 0; }
        .word-details { flex-grow: 1; }
        .word-details .word { font-size: 1.2em; font-weight: bold; }
        .definition-item { margin-top: 8px; margin-left: 10px; }
        .definition-item .pos { font-style: italic; color: var(--gray); margin-right: 8px; }
        .definition-item .meaning { font-weight: 500; }
        .definition-item .example { color: #555; margin-top: 4px; font-size: 0.9em; }
        #quiz-container, #feedback-container { display: none; padding: 20px; margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; }
        #quiz-word { font-size: 2em; font-weight: bold; text-align: center; margin-bottom: 20px; }
        #quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .option-btn { width: 100%; padding: 15px; background-color: #f1f1f1; color: #333; text-align: left; font-size: 1em; }
        .option-btn:hover { background-color: #e0e0e0; }
        #feedback-container { background-color: #fffbe6; border-color: #ffe58f; }
        #feedback-container.correct { background-color: #e9f7ef; border-color: #a6d9b8; }
        .feedback-actions { margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>è‹±å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒª (è¤‡æ•°æ„å‘³å¯¾å¿œç‰ˆ)</h1>
        
        <div class="controls">
            <input type="text" id="json-files-input" value="Words_01.json" placeholder="Words_01.json ...">
            <button id="load-btn" class="btn-primary">ğŸ”„ èª­è¾¼</button>
            <button id="export-btn" class="btn-secondary">ğŸ“„ ãƒã‚§ãƒƒã‚¯ã—ãŸå˜èªã‚’ä¿å­˜</button>
            <button id="start-quiz-btn" class="btn-success">ğŸ§  4æŠãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        </div>

        <div id="list-container">
            <h2>å˜èªãƒªã‚¹ãƒˆ (<span id="word-count">0</span>)</h2>
            <ul id="word-list"></ul>
        </div>

        <div id="quiz-container">
            <h2 id="quiz-progress">4æŠãƒ†ã‚¹ãƒˆ</h2>
            <div id="quiz-word"></div>
            <div id="quiz-options"></div>
        </div>

        <div id="feedback-container">
            <h2 id="feedback-title">ä¸æ­£è§£... ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ</h2>
            <div class="word-details" id="feedback-details"></div>
            <div class="feedback-actions">
                <button id="undo-check-btn" class="btn-secondary">ã‚„ã£ã±ã‚Šå–ã‚Šæ¶ˆã™</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOMè¦ç´ ã®å–å¾— ---
    const jsonFilesInput = document.getElementById('json-files-input');
    const loadBtn = document.getElementById('load-btn');
    const exportBtn = document.getElementById('export-btn');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    const wordListEl = document.getElementById('word-list');
    const wordCountEl = document.getElementById('word-count');
    const quizContainer = document.getElementById('quiz-container');
    const listContainer = document.getElementById('list-container');
    const quizProgressEl = document.getElementById('quiz-progress');
    const quizWordEl = document.getElementById('quiz-word');
    const quizOptionsEl = document.getElementById('quiz-options');
    const feedbackContainer = document.getElementById('feedback-container');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackDetailsEl = document.getElementById('feedback-details');
    const undoCheckBtn = document.getElementById('undo-check-btn');

    // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ç®¡ç† ---
    let allWords = []; // {id, word, checked, definitions: [...]} ã®é…åˆ—
    let quizItems = []; // {id, word, definition, checked} ã®é…åˆ—
    let currentQuizIndex = 0;
    let lastIncorrectWordId = null;

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    loadBtn.addEventListener('click', loadWords);
    exportBtn.addEventListener('click', exportCheckedWords);
    startQuizBtn.addEventListener('click', startQuiz);
    undoCheckBtn.addEventListener('click', undoLastCheck);

    wordListEl.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
            const wordId = parseInt(e.target.dataset.id);
            const word = allWords.find(w => w.id === wordId);
            if (word) {
                word.checked = e.target.checked;
                e.target.closest('.word-item').classList.toggle('checked', word.checked);
            }
        }
    });

    // --- é–¢æ•°å®šç¾© ---

    // è¤‡æ•°ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
    async function loadWords() {
        const filenames = jsonFilesInput.value.split(',').map(f => f.trim()).filter(f => f);
        if (filenames.length === 0) return alert('ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');

        try {
            const responses = await Promise.all(filenames.map(f => fetch(f)));
            for (const res of responses) {
                if (!res.ok) throw new Error(`${res.url} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
            }
            const dataArrays = await Promise.all(responses.map(res => res.json()));
            
            const wordMap = new Map();
            dataArrays.flat().forEach(word => wordMap.set(word.id, word));
            allWords = Array.from(wordMap.values());
            
            renderWordList();
            alert(`${allWords.length}èªã®å˜èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            console.error(error);
        }
    }

    // å˜èªãƒªã‚¹ãƒˆã‚’HTMLã«æç”»ã™ã‚‹é–¢æ•°
    function renderWordList() {
        wordListEl.innerHTML = '';
        allWords.sort((a, b) => a.word.localeCompare(b.word)); // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †
        
        allWords.forEach(word => {
            const li = document.createElement('li');
            li.className = 'word-item';
            if(word.checked) li.classList.add('checked');

            // è¤‡æ•°ã®å®šç¾©ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦HTMLã‚’ç”Ÿæˆ
            let definitionsHtml = '';
            word.definitions.forEach(def => {
                definitionsHtml += `
                    <div class="definition-item">
                        <div>
                            <span class="pos">${def.pos}</span>
                            <span class="meaning">${def.meaning}</span>
                        </div>
                        <div class="example">ä¾‹: ${def.example}</div>
                    </div>
                `;
            });

            li.innerHTML = `
                <input type="checkbox" data-id="${word.id}" ${word.checked ? 'checked' : ''}>
                <div class="word-details">
                    <div><span class="word">${word.word}</span></div>
                    ${definitionsHtml}
                </div>
            `;
            wordListEl.appendChild(li);
        });
        wordCountEl.textContent = allWords.length;
    }

    // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸå˜èªã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportCheckedWords() {
        const checkedWords = allWords.filter(w => w.checked);
        if (checkedWords.length === 0) return alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å˜èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        // (ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›ã¨åŒã˜)
        const jsonString = JSON.stringify(checkedWords, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.download = `CheckWords_${timestamp}.json`;
        a.href = url;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // 4æŠãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
    function startQuiz() {
        const uncheckedWords = allWords.filter(w => !w.checked);
        if (uncheckedWords.length === 0) {
             return alert('ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®å˜èªï¼ˆæœªãƒã‚§ãƒƒã‚¯ï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        }

        // ãƒ†ã‚¹ãƒˆç”¨ã®ã€Œå˜èª-æ„å‘³ã€ãƒšã‚¢ã‚’ä½œæˆ
        quizItems = [];
        uncheckedWords.forEach(word => {
            word.definitions.forEach(def => {
                quizItems.push({
                    id: word.id, // å…ƒã®å˜èªã®ID
                    word: word.word,
                    definition: def,
                    checked: word.checked
                });
            });
        });

        if (quizItems.length < 4) {
            return alert('ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã«ã¯ã€æœªãƒã‚§ãƒƒã‚¯ã®å˜èªï¼ˆã¨æ„å‘³ã®ãƒšã‚¢ï¼‰ãŒ4ã¤ä»¥ä¸Šå¿…è¦ã§ã™ã€‚');
        }
        
        // Fisher-Yatesã‚·ãƒ£ãƒƒãƒ•ãƒ«
        for (let i = quizItems.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [quizItems[i], quizItems[j]] = [quizItems[j], quizItems[i]];
        }
        
        currentQuizIndex = 0;
        listContainer.style.display = 'none';
        feedbackContainer.style.display = 'none';
        quizContainer.style.display = 'block';
        displayQuizQuestion();
    }
    
    // ã‚¯ã‚¤ã‚ºã®å•é¡Œã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayQuizQuestion() {
        if (currentQuizIndex >= quizItems.length) {
            alert('ãƒ†ã‚¹ãƒˆçµ‚äº†ã§ã™ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚');
            listContainer.style.display = 'block';
            quizContainer.style.display = 'none';
            renderWordList(); // ãƒ†ã‚¹ãƒˆä¸­ã«ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸå˜èªã‚’åæ˜ 
            return;
        }

        const currentQuizItem = quizItems[currentQuizIndex];
        const correctAnswerDef = currentQuizItem.definition;
        
        quizProgressEl.textContent = `4æŠãƒ†ã‚¹ãƒˆ (${currentQuizIndex + 1} / ${quizItems.length})`;
        quizWordEl.textContent = currentQuizItem.word;
        
        // é¸æŠè‚¢ã‚’ä½œæˆ (æ­£è§£ã®ã€Œæ„å‘³ã€ãŒåŸºæº–)
        let options = [correctAnswerDef];
        while (options.length < 4) {
            // ä»–ã®å˜èªã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å®šç¾©ã‚’1ã¤é¸ã¶
            const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
            const randomDef = randomWord.definitions[Math.floor(Math.random() * randomWord.definitions.length)];
            
            // æ„å‘³ãŒé‡è¤‡ã—ãªã„ã‚ˆã†ã«è¿½åŠ 
            if (!options.some(opt => opt.meaning === randomDef.meaning)) {
                options.push(randomDef);
            }
        }
        
        // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        options.sort(() => Math.random() - 0.5);
        
        quizOptionsEl.innerHTML = '';
        options.forEach(opt => {
            const button = document.createElement('button');
            button.className = 'option-btn';
            button.textContent = opt.meaning;
            // æ­£è§£ã®ã€Œæ„å‘³ã€ã¨ä¸€è‡´ã™ã‚‹ã‹ã§åˆ¤å®š
            button.onclick = () => handleAnswer(opt.meaning === correctAnswerDef.meaning, currentQuizItem);
            quizOptionsEl.appendChild(button);
        });
    }

    // å›ç­”ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
    function handleAnswer(isCorrect, quizItem) {
        if (isCorrect) {
            feedbackContainer.style.display = 'none';
            currentQuizIndex++;
            displayQuizQuestion();
        } else {
            // ä¸æ­£è§£ã®å‡¦ç†
            const originalWord = allWords.find(w => w.id === quizItem.id);
            if (originalWord) {
                originalWord.checked = true; // å…ƒã®å˜èªã‚’ãƒã‚§ãƒƒã‚¯
                lastIncorrectWordId = originalWord.id;
                
                feedbackTitle.textContent = 'ä¸æ­£è§£... ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ';

                // ä¸æ­£è§£ã ã£ãŸå˜èªã®ã€Œã™ã¹ã¦ã®æ„å‘³ã€ã‚’è¡¨ç¤º
                let definitionsHtml = '';
                originalWord.definitions.forEach(def => {
                    // ä¸æ­£è§£ã ã£ãŸå®šç¾©ã‚’èµ¤å­—ã§å¼·èª¿
                    const isIncorrectDef = def.meaning === quizItem.definition.meaning;
                    definitionsHtml += `
                        <div class="definition-item" style="${isIncorrectDef ? 'font-weight:bold; color:var(--red);' : ''}">
                            <div>
                                <span class="pos">${def.pos}</span>
                                <span class="meaning">${def.meaning}</span>
                            </div>
                            <div class="example">ä¾‹: ${def.example}</div>
                        </div>
                    `;
                });

                feedbackDetailsEl.innerHTML = `
                    <div><span class="word">${originalWord.word}</span></div>
                    ${definitionsHtml}
                `;
                feedbackContainer.style.display = 'block';
            }
        }
    }
    
    // ç›´å‰ã®ä¸æ­£è§£ã«ã‚ˆã‚‹ãƒã‚§ãƒƒã‚¯ã‚’å–ã‚Šæ¶ˆã™é–¢æ•°
    function undoLastCheck() {
        if (lastIncorrectWordId !== null) {
            const word = allWords.find(w => w.id === lastIncorrectWordId);
            if (word) {
                word.checked = false;
                lastIncorrectWordId = null;
                feedbackContainer.style.display = 'none';
                alert(`ã€Œ${word.word}ã€ã®ãƒã‚§ãƒƒã‚¯ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚`);
            }
        }
    }

    // åˆæœŸèª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¦è‡ªå‹•èª­ã¿è¾¼ã¿ï¼‰
    loadWords();
});
</script>
</body>
</html>
